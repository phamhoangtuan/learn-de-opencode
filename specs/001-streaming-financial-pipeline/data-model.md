# Data Model: Streaming Financial Transaction Pipeline

**Date**: 2026-02-16  
**Source**: `spec.md` Key Entities + Data Quality Requirements  
**Storage**: Apache Iceberg (format version 2), Parquet with ZSTD compression

## Entity Relationship Diagram

```
┌─────────────┐       ┌──────────────────┐       ┌───────────────┐
│   Account   │ 1───* │   Transaction    │ 1───* │    Alert      │
│             │       │                  │       │               │
│ account_id  │       │ transaction_id   │       │ alert_id      │
│ account_type│       │ timestamp        │       │ transaction_id│──FK──┐
│ creation_dt │       │ account_id ──FK──┤       │ rule_name ─FK─┤      │
│ country     │       │ amount           │       │ severity      │      │
└─────────────┘       │ currency         │       │ alert_ts      │      │
                      │ merchant_name    │       │ description   │      │
                      │ merchant_category│       └───────────────┘      │
                      │ transaction_type │                              │
                      │ location_country │       ┌───────────────┐      │
                      │ status           │       │ Alerting Rule │      │
                      │ processing_ts    │       │               │      │
                      │ partition_date   │       │ rule_name     │──────┘
                      │ is_flagged       │       │ rule_type     │
                      └──────────────────┘       │ parameters    │
                                                 │ severity      │
                                                 │ enabled       │
                                                 └───────────────┘
```

## Entities

### 1. Account (Generator-internal)

Used by the data generator to maintain a pool of realistic accounts. Not persisted to Iceberg — exists only in generator memory.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `account_id` | `string` | PK, alphanumeric, 10-12 chars | Unique account identifier |
| `account_type` | `string` | enum: `checking`, `savings`, `credit` | Type of financial account |
| `creation_date` | `date` | ISO 8601, past date | When the account was opened |
| `country` | `string` | 2-letter ISO 3166 | Account holder's country |

**Pool size**: ~1000 pre-generated accounts at startup.

---

### 2. Transaction (Kafka + Iceberg)

Primary entity flowing through the pipeline. Published as JSON to Kafka, persisted as Parquet to Iceberg.

#### Kafka Schema (raw-transactions topic)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `transaction_id` | `string` | PK, UUID v4 format | Globally unique transaction identifier |
| `timestamp` | `string` | ISO 8601 with timezone, not future >1min | When the transaction occurred (event time) |
| `account_id` | `string` | FK→Account, alphanumeric | Account initiating the transaction |
| `amount` | `decimal` | Non-zero, range: -50000.00 to 50000.00 | Monetary value (negative for refunds) |
| `currency` | `string` | 3-letter ISO 4217: USD, EUR, GBP, JPY (minimum) | Transaction currency |
| `merchant_name` | `string` | Non-empty, max 100 chars | Merchant or counterparty name |
| `merchant_category` | `string` | enum: `retail`, `dining`, `travel`, `online`, `groceries`, `entertainment`, `utilities` | Merchant Classification Code category |
| `transaction_type` | `string` | enum: `purchase`, `withdrawal`, `transfer`, `refund` | Type of financial operation |
| `location_country` | `string` | 2-letter ISO 3166 | Country where transaction occurred |
| `status` | `string` | enum: `pending`, `completed`, `failed`, `reversed` | Current transaction state |

#### State Transitions

```
pending ──→ completed ──→ reversed
   │
   └──→ failed
```

- `pending → completed`: Normal successful transaction
- `pending → failed`: Transaction declined or error
- `completed → reversed`: Chargeback or reversal
- No other transitions are valid

#### Iceberg Schema (transactions table)

All Kafka fields plus enrichment fields added by Flink:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| *(all Kafka fields above)* | | | |
| `processing_timestamp` | `timestamp_tz` | ISO 8601, auto-set by Flink | When the record was processed by Flink |
| `partition_date` | `date` | Derived from `timestamp` | Date extracted for Iceberg partitioning |
| `is_flagged` | `boolean` | Default: false | Whether any alerting rule triggered |

**Partitioning**: `days(timestamp)` — one partition per calendar day.  
**Sort order**: `transaction_id` ascending within each partition.

---

### 3. Alert (Kafka + Iceberg)

Generated by Flink when a transaction matches an alerting rule. Published to Kafka alerts topic, persisted to Iceberg alerts table.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `alert_id` | `string` | PK, UUID v4 format | Globally unique alert identifier |
| `transaction_id` | `string` | FK→Transaction, UUID format | Transaction that triggered the alert |
| `rule_name` | `string` | FK→AlertingRule, non-empty | Which rule triggered this alert |
| `severity` | `string` | enum: `low`, `medium`, `high`, `critical` | Alert severity level |
| `alert_timestamp` | `timestamp_tz` | ISO 8601, auto-set by Flink | When the alert was generated |
| `description` | `string` | Non-empty, max 500 chars | Human-readable explanation |

**Partitioning**: `days(alert_timestamp)` — one partition per calendar day.  
**Relationship**: Many alerts can reference the same transaction (multiple rules triggered).

---

### 4. Alerting Rule (Configuration File)

Not stored in Iceberg — loaded from a YAML configuration file at Flink startup and reloaded on change (FR-016).

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `rule_name` | `string` | PK, unique, slug format | Rule identifier (e.g., `high-value-transaction`) |
| `rule_type` | `string` | enum: `threshold`, `velocity`, `time_based` | Category of rule logic |
| `parameters` | `map<string, string>` | Required, rule-type-specific | Threshold values, time windows, etc. |
| `severity` | `string` | enum: `low`, `medium`, `high`, `critical` | Default severity when triggered |
| `enabled` | `boolean` | Default: true | Active/inactive toggle |

#### Default Rules

| rule_name | rule_type | parameters | severity |
|-----------|-----------|------------|----------|
| `high-value-transaction` | `threshold` | `{"amount_threshold": "10000"}` | `high` |
| `rapid-activity` | `velocity` | `{"max_count": "5", "window_minutes": "1"}` | `medium` |
| `unusual-hour` | `time_based` | `{"quiet_start": "01:00", "quiet_end": "05:00"}` | `low` |

---

## Validation Rules Summary

| Rule | Dimension | Applied At |
|------|-----------|-----------|
| `transaction_id` is UUID and unique | Uniqueness | Generator + Flink |
| `timestamp` is valid ISO 8601, not future >1min | Validity | Flink |
| `amount` is non-zero | Validity | Generator + Flink |
| `currency` is valid ISO 4217 (USD, EUR, GBP, JPY) | Validity | Flink |
| `merchant_category` is from predefined enum | Validity | Flink |
| `transaction_type` is from allowed values | Validity | Flink |
| All required fields present and non-null | Completeness | Flink |
| Records arrive within 30s of generation | Timeliness | Flink (monitoring) |
| State transitions follow linear model | Consistency | Generator |

**Invalid records**: Routed to `dead-letter` Kafka topic with error details (field name, expected format, actual value).

---

## Dead Letter Record Schema

Records routed to the `dead-letter` Kafka topic when validation fails:

| Field | Type | Description |
|-------|------|-------------|
| `original_record` | `string` | Raw JSON of the failed transaction |
| `error_field` | `string` | Which field caused the validation failure |
| `error_type` | `string` | Type of validation failure (e.g., `missing`, `invalid_format`, `out_of_range`) |
| `expected_format` | `string` | What was expected (e.g., `UUID`, `ISO 8601`, `non-zero decimal`) |
| `actual_value` | `string` | The actual value that failed validation (or `null`) |
| `error_timestamp` | `string` | ISO 8601 when the error was detected |
| `processor_id` | `string` | Which Flink subtask detected the error |

---

## Pipeline Session Metadata (Iceberg table)

Technical metadata captured per pipeline session (FR-017, constitution Principle IV):

| Field | Type | Description |
|-------|------|-------------|
| `session_id` | `string` | UUID for this pipeline run |
| `start_timestamp` | `timestamp_tz` | When the session started |
| `end_timestamp` | `timestamp_tz` | When the session ended (null if running) |
| `records_generated` | `long` | Total records produced by generator |
| `records_published` | `long` | Total records sent to Kafka |
| `records_processed` | `long` | Total records processed by Flink |
| `records_stored` | `long` | Total records written to Iceberg |
| `alerts_generated` | `long` | Total alerts created |
| `records_dead_lettered` | `long` | Total records routed to DLQ |
| `throughput_avg` | `double` | Average records/sec |
| `latency_p50_ms` | `long` | 50th percentile end-to-end latency |
| `latency_p95_ms` | `long` | 95th percentile end-to-end latency |
| `latency_p99_ms` | `long` | 99th percentile end-to-end latency |

**Partitioning**: None (low volume — one row per session).
